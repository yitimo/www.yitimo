<script>
    /**
    * 我会做些什么：
    *   1. 读取参数中的code
    *   2. 读取本地文件中的配置
    *   3. 使用配置组合code请求得到accesstoken
    *   4. 将at保存到文件，关闭此窗口
    */
    try {
        var https = require('https');
        var fs = require('fs');
        var href = window.location.href;
        var code = href.slice(href.indexOf('code=') + 5);
        fs.readFile('appconfig', 'utf8', function (err, data) {
            if (err) throw err;
            var config = JSON.parse(data);
            var req = https.request({
                host: 'api.weibo.com',
                path: '/oauth2/access_token?client_id=' + config.client_id +
                    '&client_secret=' + config.client_secret +
                    '&grant_type=authorization_code&code=' + code +
                    '&redirect_uri=' + config.redirect_uri,
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }, function(res) {
                res.setEncoding('utf8');
                res.on('data', function(chunk) {
                    fs.writeFile('accesstoken', chunk, function (err) {
                        if (err) throw err;
                        window.opener.postMessage('authed');
                        window.close();
                        console.log('It\'s saved!'); //文件被保存
                    });
                });
                res.on('error', function(chunk) {
                    document.writeln(chunk);
                });
            });
            req.end();
        });
    } catch(e) {
        alert('页面出错');
        document.write(JSON.stringify(e));
    }
</script>